#!/usr/bin/env bash

# Profile Setup Script
# Sets the active profile for this environment

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROFILE="${1:-}"

show_usage() {
    echo "Usage: ./setup <profile-name>"
    echo ""
    echo "This sets which profile to use for this machine."
    echo ""
    echo "If you have a new machine, create a profile first:"
    echo "  1. Look at profiles/ directory for examples"
    echo "  2. Create: profiles/my-new-machine"
    echo "  3. List scripts to run (one per line)"
    echo "  4. Run: ./setup my-new-machine"
    echo ""
    echo "Example profiles in this repo:"
    if [ -d "$SCRIPT_DIR/profiles" ]; then
        for profile in "$SCRIPT_DIR/profiles"/*; do
            if [ -f "$profile" ]; then
                name=$(basename "$profile")
                # Show first comment line as description
                desc=$(grep -m 1 "^# " "$profile" | sed 's/^# //' || echo "")
                if [ -n "$desc" ]; then
                    printf "  %-20s - %s\n" "$name" "$desc"
                else
                    printf "  %s\n" "$name"
                fi
            fi
        done
    fi
    echo ""
    echo "These are just examples. Create your own for your specific machine!"
}

if [ "$PROFILE" == "--list" ] || [ "$PROFILE" == "-l" ]; then
    show_usage
    exit 0
fi

if [ -z "$PROFILE" ]; then
    echo "Error: No profile specified"
    echo ""
    show_usage
    exit 1
fi

if [ ! -f "$SCRIPT_DIR/profiles/$PROFILE" ]; then
    echo "Error: Profile '$PROFILE' not found"
    echo ""
    show_usage
    exit 1
fi

# Create .profile file
echo "$PROFILE" > "$SCRIPT_DIR/.profile"

echo "âœ“ Profile set to: $PROFILE"
echo ""
echo "Profile location: $SCRIPT_DIR/profiles/$PROFILE"
echo ""
echo "To run setup for this profile:"
echo "  cd $SCRIPT_DIR"
echo "  DEV_ENV=\$(pwd) ./run"
