#!/usr/bin/env bash

# Hyprland Configuration Run - Shared
# Installs Hyprland and creates symlinks to config files
# Machine-specific settings (like Nvidia) should go in separate scripts

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DOTFILES_DIR="$(dirname "$SCRIPT_DIR")"
source "$SCRIPT_DIR/_common.sh"

echo "Setting up Hyprland configuration..."

# Install Hyprland and hyprshot
echo "Installing Hyprland and hyprshot..."
install_packages hyprland hyprshot

# Create .config/hypr directory if it doesn't exist
mkdir -p "$HOME/.config/hypr"

# Backup existing hyprland.conf if it exists and isn't a symlink
if [ -f "$HOME/.config/hypr/hyprland.conf" ] && [ ! -L "$HOME/.config/hypr/hyprland.conf" ]; then
    echo "Backing up existing hyprland.conf to hyprland.conf.backup"
    cp "$HOME/.config/hypr/hyprland.conf" "$HOME/.config/hypr/hyprland.conf.backup"
fi

# Create symlink from dotfiles
echo "Creating symlink to hyprland.conf"
ln -sf "$DOTFILES_DIR/files/hypr/hyprland.conf" "$HOME/.config/hypr/hyprland.conf"

# Create local.conf with T480 laptop-specific settings
echo "Creating local.conf with T480 monitor configuration"
cat > "$HOME/.config/hypr/local.conf" << 'EOF'
# Machine-specific Hyprland configuration
# This file is sourced by the main hyprland.conf

# Monitor configuration for T480 laptop
# Format: monitor=name,resolution@refresh,position,scale
# eDP-1 is the built-in laptop display
# Scale set to 1.25 (auto-detection defaults to 1.5x which is too large, 1.0 is too small)
monitor=eDP-1,1920x1080@60,0x0,1.25
EOF

echo "Hyprland configuration installed successfully!"
echo ""
echo "Note: Machine-specific settings can be added to ~/.config/hypr/local.conf"
echo "      This file is sourced by hyprland.conf and won't be overwritten."
