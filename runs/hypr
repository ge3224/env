#!/usr/bin/env bash

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DOTFILES_DIR="$(dirname "$SCRIPT_DIR")"
source "$SCRIPT_DIR/_common.sh"

echo "Setting up Hyprland configuration..."

echo "Installing Hyprland and hyprshot..."
install_packages hyprland hyprshot

mkdir -p "$HOME/.config/hypr"
if [ -e "$HOME/.config/hypr/hyprland.conf" ]; then
    if [ -L "$HOME/.config/hypr/hyprland.conf" ]; then
        CURRENT_TARGET=$(readlink "$HOME/.config/hypr/hyprland.conf")
        if [ "$CURRENT_TARGET" = "$DOTFILES_DIR/files/hypr/hyprland.conf" ]; then
            echo "hyprland.conf symlink already points to correct target, skipping"
        else
            echo "Existing hyprland.conf symlink points to different location, updating"
            rm "$HOME/.config/hypr/hyprland.conf"
            ln -sf "$DOTFILES_DIR/files/hypr/hyprland.conf" "$HOME/.config/hypr/hyprland.conf"
        fi
    else
        echo "Backing up existing hyprland.conf to hyprland.conf.backup"
        cp "$HOME/.config/hypr/hyprland.conf" "$HOME/.config/hypr/hyprland.conf.backup"
        ln -sf "$DOTFILES_DIR/files/hypr/hyprland.conf" "$HOME/.config/hypr/hyprland.conf"
    fi
else
    ln -sf "$DOTFILES_DIR/files/hypr/hyprland.conf" "$HOME/.config/hypr/hyprland.conf"
fi

echo "Setting up local.conf..."
if [ -n "${PROFILE_HYPR_LOCAL:-}" ]; then
    LOCAL_SOURCE="$DOTFILES_DIR/$PROFILE_HYPR_LOCAL"
    if [ -f "$LOCAL_SOURCE" ]; then
        echo "Using profile-specific local config: $PROFILE_HYPR_LOCAL"
        ln -sf "$LOCAL_SOURCE" "$HOME/.config/hypr/local.conf"
    else
        echo "Warning: Profile specified local config not found: $PROFILE_HYPR_LOCAL"
        echo "Creating empty local.conf"
        touch "$HOME/.config/hypr/local.conf"
    fi
else
    echo "No profile-specific local config, creating empty local.conf"
    touch "$HOME/.config/hypr/local.conf"
fi

echo "Hyprland configuration installed successfully!"
echo ""
echo "Note: Machine-specific settings can be added to ~/.config/hypr/local.conf"
echo "      This file is sourced by hyprland.conf and won't be overwritten."
