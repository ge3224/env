#!/usr/bin/env bash

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/_common.sh"

echo "Setting up comprehensive font configuration..."

FONT_PACKAGES=(
    "ttf-dejavu"
    "ttf-liberation"
    "noto-fonts"
    "noto-fonts-emoji"
    "noto-fonts-cjk"
    "ttf-firacode-nerd"
    "ttf-jetbrains-mono-nerd"
    "ttf-sourcecodepro-nerd"
    "inter-font"
    "ttf-opensans"
    "ttf-roboto"
    "ttf-ubuntu-font-family"
    "terminus-font"
    "ttf-inconsolata"
)

echo "Installing font packages..."
install_packages "${FONT_PACKAGES[@]}"

echo "Enabling subpixel RGB rendering system-wide..."
if [ ! -e /etc/fonts/conf.d/10-sub-pixel-rgb.conf ]; then
    sudo ln -s /usr/share/fontconfig/conf.avail/10-sub-pixel-rgb.conf /etc/fonts/conf.d/10-sub-pixel-rgb.conf
    echo "Enabled subpixel RGB rendering"
else
    echo "Subpixel RGB rendering already enabled"
fi

echo "Updating font cache..."
fc-cache -f

echo "Setting console font..."
if [[ -f /usr/share/kbd/consolefonts/ter-116n.psf.gz ]]; then
    sudo setfont ter-116n
    echo "FONT=ter-116n" | sudo tee /etc/vconsole.conf
else
    echo "Warning: Terminus font not found, using default console font"
fi

echo "Setting up fontconfig..."
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DOTFILES_DIR="$(dirname "$SCRIPT_DIR")"
mkdir -p "$HOME/.config/fontconfig"
if [[ -f "$DOTFILES_DIR/files/fontconfig/fonts.conf" ]]; then
    if [ -e "$HOME/.config/fontconfig/fonts.conf" ]; then
        if [ -L "$HOME/.config/fontconfig/fonts.conf" ]; then
            CURRENT_TARGET=$(readlink "$HOME/.config/fontconfig/fonts.conf")
            if [ "$CURRENT_TARGET" = "$DOTFILES_DIR/files/fontconfig/fonts.conf" ]; then
                echo "fonts.conf symlink already points to correct target, skipping"
            else
                echo "Existing fonts.conf symlink points to different location, updating"
                rm "$HOME/.config/fontconfig/fonts.conf"
                ln -sf "$DOTFILES_DIR/files/fontconfig/fonts.conf" "$HOME/.config/fontconfig/fonts.conf"
            fi
        else
            echo "Backing up existing fontconfig to fonts.conf.backup"
            cp "$HOME/.config/fontconfig/fonts.conf" "$HOME/.config/fontconfig/fonts.conf.backup"
            ln -sf "$DOTFILES_DIR/files/fontconfig/fonts.conf" "$HOME/.config/fontconfig/fonts.conf"
        fi
    else
        ln -sf "$DOTFILES_DIR/files/fontconfig/fonts.conf" "$HOME/.config/fontconfig/fonts.conf"
    fi
    echo "Linked fontconfig configuration"
else
    echo "Warning: fontconfig file not found"
fi

echo "Font setup completed!"
echo ""
echo "Installed fonts summary:"
echo "- DejaVu: General purpose with excellent Unicode coverage"
echo "- Liberation: Metric-compatible with MS Office fonts"
echo "- Noto: Google's comprehensive Unicode font family"
echo "- FiraCode/JetBrains Mono: Programming fonts with ligatures"
echo "- Terminus: High-quality console font"
echo ""
echo "Run 'fc-list' to see all available fonts"
echo "Run 'fc-match font-name' to test font matching"
