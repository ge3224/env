#!/usr/bin/env bash

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/_common.sh"

echo "Configuring T480-specific hardware optimizations..."

echo "Installing throttled package..."
install_packages throttled

echo "Enabling throttled service..."
sudo systemctl enable --now throttled

echo "Installing msr-tools..."
install_packages msr-tools

echo "Creating throttlestop script..."
sudo tee /usr/local/bin/throttlestop > /dev/null <<'EOF'
#!/bin/bash
modprobe msr
reg="$(rdmsr -d 0x1FC)"
if [ $((reg%2)) -eq 1 ]; then
    wrmsr 0x1FC $((reg-1))
fi
EOF

sudo chmod 0755 /usr/local/bin/throttlestop

echo "Creating throttlestop systemd service..."
sudo tee /etc/systemd/system/throttlestop.service > /dev/null <<'EOF'
[Unit]
Description=Disable BD PROCHOT throttling
After=multi-user.target

[Service]
Type=oneshot
ExecStart=/usr/local/bin/throttlestop
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
EOF

echo "Enabling throttlestop service..."
sudo systemctl enable --now throttlestop

echo "Installing fwupd for firmware updates..."
install_packages fwupd

echo "Configuring backlight control (brightnessctl)..."

echo "Adding user to video group..."
sudo usermod -aG video "$USER"

echo "Creating udev rules for backlight control..."
sudo tee /etc/udev/rules.d/90-backlight.rules > /dev/null <<'EOF'
SUBSYSTEM=="backlight", ACTION=="add", \
  RUN+="/bin/chgrp video /sys/class/backlight/%k/brightness", \
  RUN+="/bin/chmod g+w /sys/class/backlight/%k/brightness"

SUBSYSTEM=="leds", ACTION=="add", KERNEL=="*::kbd_backlight", \
  RUN+="/bin/chgrp video /sys/class/leds/%k/brightness", \
  RUN+="/bin/chmod g+w /sys/class/leds/%k/brightness"
EOF

echo "Reloading udev rules..."
sudo udevadm control --reload-rules
sudo udevadm trigger

echo "T480 hardware configuration complete!"
echo "Note: You may need to log out and back in for group changes to take effect"
