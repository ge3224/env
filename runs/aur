#!/usr/bin/env bash

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DOTFILES_DIR="$(dirname "$SCRIPT_DIR")"
source "$SCRIPT_DIR/_common.sh"

echo "Setting up AUR package manager (maur)..."

# Check if we have internet
if [[ "${HAS_INTERNET:-false}" != "true" ]]; then
    echo "No internet connection. Skipping AUR setup."
    exit 0
fi

# Install devtools (required for chroot builds)
if ! is_package_installed "devtools"; then
    echo "Installing devtools (required for chroot builds)..."
    install_packages devtools
else
    echo "devtools already installed"
fi

# Build and install maur if not already available
if ! command -v maur &> /dev/null; then
    echo "Building and installing maur..."

    MAUR_DIR="$DOTFILES_DIR/tools/maur"
    if [[ ! -d "$MAUR_DIR" ]]; then
        echo "ERROR: maur directory not found at $MAUR_DIR"
        echo "Expected maur to be a git submodule at tools/maur"
        exit 1
    fi

    # Build maur
    cd "$MAUR_DIR"
    make clean && make

    # Install to ~/.local/bin
    make install

    # Verify installation
    if ! command -v maur &> /dev/null; then
        echo "ERROR: maur installation failed"
        echo "Make sure ~/.local/bin is in your PATH"
        exit 1
    fi

    echo "maur installed successfully"
else
    echo "maur already installed"
fi

# Initialize maur config if it doesn't exist
cd "$DOTFILES_DIR"
if [[ ! -f .maur.conf ]]; then
    echo "Creating default maur configuration..."
    cat > .maur.conf << EOF
# maur configuration
# Generated by runs/aur

# Directory where AUR package submodules are stored
aur_dir=aur

# Directory where packages are built
build_dir=/tmp/maur-builds

# Chroot type for building (extra-x86_64, multilib, etc.)
chroot_type=extra-x86_64
EOF
    echo "Created .maur.conf (note: this file is in .gitignore)"
else
    echo "maur config already exists"
fi

# Initialize chroot build environment
echo "Initializing chroot build environment..."
echo "This may take a few minutes on first run..."
if maur chroot-init; then
    echo "Chroot initialized successfully"
else
    echo "WARNING: chroot initialization failed"
    echo "You may need to run manually: maur chroot-init"
fi

# Initialize AUR package submodules
if [[ -d "$DOTFILES_DIR/aur" ]]; then
    echo "Initializing AUR package submodules..."

    # Update submodules
    git submodule update --init --recursive aur/

    # Count packages
    PKG_COUNT=$(ls -1 "$DOTFILES_DIR/aur" 2>/dev/null | wc -l)

    if [[ $PKG_COUNT -gt 0 ]]; then
        echo "Found $PKG_COUNT AUR package(s)"

        # List packages
        echo "AUR packages managed by maur:"
        maur list

        # Optional: update and install all packages
        # Uncomment if you want automatic installation on setup
        # echo "Updating and installing AUR packages..."
        # maur update
    else
        echo "No AUR packages found in aur/ directory"
        echo "Add packages with: maur add <package-name>"
    fi
else
    echo "No aur/ directory found"
    echo "Add your first package with: maur add <package-name>"
fi

echo "AUR setup completed!"
echo ""
echo "Usage:"
echo "  maur add <package>     - Add new AUR package"
echo "  maur update            - Update all packages"
echo "  maur list              - List managed packages"
