#!/usr/bin/env bash

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DOTFILES_DIR="$(dirname "$SCRIPT_DIR")"
source "$SCRIPT_DIR/_common.sh"

echo "Setting up AUR package manager (maur)..."

# Check if we have internet
if [[ "${HAS_INTERNET:-false}" != "true" ]]; then
    echo "No internet connection. Skipping AUR setup."
    exit 0
fi

# Install devtools (required for chroot builds)
if ! is_package_installed "devtools"; then
    echo "Installing devtools (required for chroot builds)..."
    install_packages devtools
else
    echo "devtools already installed"
fi

# Build and install maur if not already available
if ! command -v maur &> /dev/null; then
    echo "Building and installing maur..."

    MAUR_DIR="$DOTFILES_DIR/tools/maur"
    if [[ ! -d "$MAUR_DIR" ]]; then
        echo "ERROR: maur directory not found at $MAUR_DIR"
        echo "Expected maur to be a git submodule at tools/maur"
        exit 1
    fi

    # Build maur
    cd "$MAUR_DIR"
    make clean && make

    # Install to ~/.local/bin
    make install

    # Verify installation
    if ! command -v maur &> /dev/null; then
        echo "ERROR: maur installation failed"
        echo "Make sure ~/.local/bin is in your PATH"
        exit 1
    fi

    echo "maur installed successfully"
else
    echo "maur already installed"
fi

# maur uses XDG directories by default (~/.cache/maur, ~/.config/maur/config)
# No need to create .maur.conf in the repo anymore
echo "maur will use default configuration:"
echo "  Cache: ~/.cache/maur"
echo "  Config: ~/.config/maur/config"
echo "  Build: /var/tmp/maur-builds (or same as cache)"

# Initialize chroot build environment
# Check if chroot already exists (maur uses /var/lib/archbuild/maur by default)
if [[ -d /var/lib/archbuild/maur ]] || [[ -d "$HOME/.cache/maur/chroot" ]]; then
    echo "Chroot build environment already initialized"
else
    echo "Initializing chroot build environment..."
    echo "This may take a few minutes on first run..."
    if maur chroot-init; then
        echo "Chroot initialized successfully"
    else
        echo "WARNING: chroot initialization failed"
        echo "You may need to run manually: maur chroot-init"
    fi
fi

# Install packages specified in profile
if [[ -n "${PROFILE_AUR_PACKAGES:-}" ]]; then
    echo ""
    echo "Installing AUR packages from profile..."

    # Get list of cached packages for efficient lookup
    CACHED_PACKAGES=$(maur list 2>/dev/null || echo "")

    # Split comma-separated package list
    IFS=',' read -ra PACKAGES <<< "$PROFILE_AUR_PACKAGES"

    for pkg in "${PACKAGES[@]}"; do
        # Trim whitespace
        pkg="${pkg// /}"

        echo ""
        echo "=== Processing $pkg ==="

        # Check if package is already in maur cache
        if echo "$CACHED_PACKAGES" | grep -q "^$pkg$"; then
            echo "$pkg is already cached"

            # Check if installed
            if pacman -Q "$pkg" &>/dev/null; then
                echo "$pkg is already installed"
            else
                echo "Installing $pkg from cache..."
                maur install "$pkg"
            fi
        else
            # Not in cache - add it (will also install if not already installed)
            echo "Adding $pkg to cache..."
            maur add "$pkg"
        fi
    done

    echo ""
    echo "Profile AUR packages processed"
else
    echo ""
    echo "No aur.packages specified in profile"
    echo "Add 'aur.packages=pkg1,pkg2' to your profile to auto-install packages"
    echo ""
    echo "Currently cached packages:"
    maur list
fi

echo "AUR setup completed!"
echo ""
echo "Usage:"
echo "  maur add <package>     - Add AUR package to cache and install"
echo "  maur install <package> - Build and install cached package"
echo "  maur update            - Update all cached packages"
echo "  maur list              - List cached packages"
echo "  maur remove <package>  - Remove package from cache"
