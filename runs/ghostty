#!/usr/bin/env bash

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/_common.sh"

log() {
    echo "[GHOSTTY] $1"
}

log "Setting up ghostty terminal emulator..."

log "Installing ghostty..."
if command -v pacman >/dev/null 2>&1; then
    install_packages_with_log "GHOSTTY" ghostty
else
    log "ERROR: No supported package manager found (pacman)"
    exit 1
fi

CONFIG_DIR="$HOME/.config/ghostty"
mkdir -p "$CONFIG_DIR"

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DOTFILES_DIR="$(dirname "$SCRIPT_DIR")"

SOURCE_CONFIG="$DOTFILES_DIR/files/ghostty/config"
TARGET_CONFIG="$CONFIG_DIR/config"

if [ -e "$TARGET_CONFIG" ]; then
    if [ -L "$TARGET_CONFIG" ]; then
        CURRENT_TARGET=$(readlink "$TARGET_CONFIG")
        if [ "$CURRENT_TARGET" = "$SOURCE_CONFIG" ]; then
            log "ghostty config symlink already points to correct target, skipping"
        else
            log "Existing ghostty config symlink points to different location, updating"
            rm "$TARGET_CONFIG"
            ln -sf "$SOURCE_CONFIG" "$TARGET_CONFIG"
        fi
    else
        log "Backing up existing config to $TARGET_CONFIG.backup"
        mv "$TARGET_CONFIG" "$TARGET_CONFIG.backup"
        ln -sf "$SOURCE_CONFIG" "$TARGET_CONFIG"
        log "Created ghostty config symlink (backed up existing config)"
    fi
else
    ln -sf "$SOURCE_CONFIG" "$TARGET_CONFIG"
    log "Created ghostty config symlink"
fi

log "ghostty setup complete!"