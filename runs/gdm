#!/usr/bin/env bash

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/_common.sh"

log() {
    echo "[GDM] $1"
}

log "Configuring GDM display manager..."

if ! sudo -v -n &>/dev/null; then
    log "ERROR: sudo credentials are not available or have timed out."
    log "Please run 'sudo -v' to cache your credentials and re-run the script."
    exit 1
fi

log "Installing GDM..."
install_packages_with_log "GDM" gdm
if systemctl is-enabled sddm &>/dev/null; then
    log "Disabling SDDM..."
    sudo -n systemctl disable sddm
fi
if systemctl is-enabled lightdm &>/dev/null; then
    log "Disabling LightDM..."
    sudo -n systemctl disable lightdm
fi
if ! systemctl is-enabled gdm &>/dev/null; then
    log "Enabling GDM..."
    sudo -n systemctl enable gdm
else
    log "GDM is already enabled"
fi

log "Hiding GNOME sessions from GDM session selector..."

for session_dir in "/usr/share/wayland-sessions" "/usr/share/xsessions"; do
    if [[ -d "$session_dir" ]]; then
        for session in "$session_dir"/gnome*.desktop; do
            if [[ -f "$session" ]]; then
                log "  Disabling $(basename "$session")"
                if ! sudo -n mv "$session" "${session}.disabled"; then
                    log "ERROR: Failed to disable $(basename "$session"). Missing sudo permissions?"
                    exit 1
                fi
            elif [[ -f "${session}.disabled" ]]; then
                log "  $(basename "$session") already disabled"
            fi
        done
    fi
done

log "GDM configuration completed!"
log "Key changes:"
log "  - GDM installed and enabled"
log "  - Other display managers disabled (if any)"
log "  - GNOME sessions hidden (only Hyprland will show)"
log ""
log "Reboot to use GDM as your display manager."
log "Select 'Hyprland (uwsm)' from the session menu when logging in."
