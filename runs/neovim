#!/usr/bin/env bash

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DOTFILES_DIR="$(dirname "$SCRIPT_DIR")"
source "$SCRIPT_DIR/_common.sh"

echo "Setting up neovim..."

dependencies=(
    "neovim"
    "nodejs"
    "npm"
    "go"
)

echo "Installing neovim and dependencies: ${dependencies[*]}"
install_packages "${dependencies[@]}"

echo "neovim and dependencies installed successfully!"

echo "Setting up neovim configuration submodule..."
cd "$DOTFILES_DIR"

if [ ! -d "files/nvim/.git" ]; then
    echo "Initializing nvim submodule..."
    git submodule update --init files/nvim
else
    echo "Updating nvim submodule..."
    git submodule update files/nvim
fi
if [ -e "$HOME/.config/nvim" ]; then
    if [ -L "$HOME/.config/nvim" ]; then
        echo "Existing nvim config is already a symlink, removing it"
        rm "$HOME/.config/nvim"
    else
        echo "Backing up existing nvim config to .config/nvim.backup"
        mv "$HOME/.config/nvim" "$HOME/.config/nvim.backup"
    fi
fi

echo "Creating symlink to nvim config"
ln -sf "$DOTFILES_DIR/files/nvim" "$HOME/.config/nvim"

echo "Neovim setup completed!"
echo "Run 'nvim' to start neovim with your custom configuration."