#!/usr/bin/env bash

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DOTFILES_DIR="$(dirname "$SCRIPT_DIR")"
source "$SCRIPT_DIR/_common.sh"

echo "Setting up neovim..."

dependencies=(
    "neovim"
    "nodejs"
    "npm"
    "go"
)

echo "Installing neovim and dependencies: ${dependencies[*]}"
install_packages "${dependencies[@]}"

echo "neovim and dependencies installed successfully!"

echo "Setting up neovim configuration submodule..."
cd "$DOTFILES_DIR"

if [ ! -d "files/nvim/.git" ]; then
    echo "Initializing nvim submodule..."
    git submodule update --init files/nvim
else
    echo "Updating nvim submodule..."
    git submodule update files/nvim
fi
if [ -e "$HOME/.config/nvim" ]; then
    if [ -L "$HOME/.config/nvim" ]; then
        CURRENT_TARGET=$(readlink "$HOME/.config/nvim")
        if [ "$CURRENT_TARGET" = "$DOTFILES_DIR/files/nvim" ]; then
            echo "nvim config symlink already points to correct target, skipping"
        else
            echo "Existing nvim config symlink points to different location, updating"
            rm "$HOME/.config/nvim"
            ln -sf "$DOTFILES_DIR/files/nvim" "$HOME/.config/nvim"
        fi
    else
        echo "Backing up existing nvim config to .config/nvim.backup"
        mv "$HOME/.config/nvim" "$HOME/.config/nvim.backup"
        ln -sf "$DOTFILES_DIR/files/nvim" "$HOME/.config/nvim"
    fi
else
    ln -sf "$DOTFILES_DIR/files/nvim" "$HOME/.config/nvim"
fi

echo "Neovim setup completed!"
echo "Run 'nvim' to start neovim with your custom configuration."