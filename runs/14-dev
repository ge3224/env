#!/usr/bin/env bash

set -euo pipefail

log() {
    echo "[DEV] $1"
}

log "Setting up development tools..."

# Install language tools from pacman
log "Installing language tools and package managers..."
sudo pacman -S --needed --noconfirm \
    dart \
    go \
    nodejs \
    npm \
    pnpm \
    opam \
    python-pip \
    python-pipx \
    python-poetry

# Install Deno if not present
log "Checking for Deno..."
if ! command -v deno >/dev/null 2>&1; then
    log "Installing Deno..."
    curl -fsSL https://deno.land/install.sh | sh
else
    log "Deno already installed"
fi

# Install Rust if not present
log "Checking for Rust..."
if ! command -v rustc >/dev/null 2>&1; then
    log "Installing Rust..."
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    # Source cargo env for current session
    source "$HOME/.cargo/env"
else
    log "Rust already installed"
fi

# Initialize opam if necessary
log "Checking opam initialization..."
if [ ! -d "$HOME/.opam" ]; then
    log "Initializing opam..."
    opam init -y
    eval $(opam env)
else
    log "opam already initialized"
    eval $(opam env) 2>/dev/null || true
fi

# Install OCaml tools via opam
log "Installing OCaml tools..."
for pkg in odoc ocamlformat utop; do
    if ! opam list --installed "$pkg" >/dev/null 2>&1; then
        log "Installing $pkg..."
        opam install -y "$pkg"
    else
        log "$pkg already installed"
    fi
done

# Install Docker
log "Installing Docker..."
sudo pacman -S --needed --noconfirm docker docker-compose

# Enable and start Docker service
log "Enabling Docker service..."
sudo systemctl enable --now docker

# Ensure docker group exists
log "Setting up Docker group..."
sudo groupadd -f docker

# Add user to docker group
log "Adding $USER to docker group..."
sudo usermod -aG docker "$USER"

log "Development tools installed!"
log "Note: You may need to log out and back in for group changes to take effect"
