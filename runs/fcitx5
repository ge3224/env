#!/usr/bin/env bash

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DOTFILES_DIR="$(dirname "$SCRIPT_DIR")"
source "$SCRIPT_DIR/_common.sh"

log() {
    echo "[FCITX5] $1"
}

log "Setting up fcitx5 input method framework..."

packages=(
    "fcitx5"
    "fcitx5-gtk"
    "fcitx5-qt"
    "fcitx5-configtool"
    "fcitx5-chinese-addons"
)

if command -v pacman >/dev/null 2>&1; then
    install_packages_with_log "FCITX5" "${packages[@]}"
else
    log "ERROR: No supported package manager found (pacman)"
    exit 1
fi

mkdir -p "$HOME/.config/fcitx5/conf"
mkdir -p "$HOME/.local/share/fcitx5"

if [ -f "$HOME/.config/fcitx5/profile" ]; then
    log "Backing up existing profile to profile.backup"
    cp "$HOME/.config/fcitx5/profile" "$HOME/.config/fcitx5/profile.backup"
fi

log "Copying fcitx5 profile (English + Pinyin)"
cp "$DOTFILES_DIR/files/fcitx5/profile" "$HOME/.config/fcitx5/profile"

if [ -f "$HOME/.config/fcitx5/conf/pinyin.conf" ]; then
    log "Backing up existing pinyin.conf to pinyin.conf.backup"
    cp "$HOME/.config/fcitx5/conf/pinyin.conf" "$HOME/.config/fcitx5/conf/pinyin.conf.backup"
fi

log "Copying Pinyin configuration with Traditional Chinese output"
cp "$DOTFILES_DIR/files/fcitx5/conf/pinyin.conf" "$HOME/.config/fcitx5/conf/pinyin.conf"

if [ -f "$HOME/.config/fcitx5/conf/chttrans.conf" ]; then
    log "Backing up existing chttrans.conf to chttrans.conf.backup"
    cp "$HOME/.config/fcitx5/conf/chttrans.conf" "$HOME/.config/fcitx5/conf/chttrans.conf.backup"
fi

log "Copying chttrans configuration (Ctrl+Shift+F to toggle)"
cp "$DOTFILES_DIR/files/fcitx5/conf/chttrans.conf" "$HOME/.config/fcitx5/conf/chttrans.conf"

if [ -f "$HOME/.config/fcitx5/config" ]; then
    log "Backing up existing global config to config.backup"
    cp "$HOME/.config/fcitx5/config" "$HOME/.config/fcitx5/config.backup"
fi

log "Copying fcitx5 global configuration (Ctrl+Space trigger key)"
cp "$DOTFILES_DIR/files/fcitx5/config" "$HOME/.config/fcitx5/config"

log "fcitx5 setup completed!"
log ""
log "Usage:"
log "  - Ctrl+Space: Toggle between English and Chinese input methods"
log "  - Shift: Switch between English and Chinese mode within input method"
log ""
log "Pinyin for Traditional Chinese:"
log "  - Pinyin input method configured to output Traditional Chinese"
log "  - Type pinyin to get Traditional Chinese characters"
log "  - Example: 'nihao' → 你好"
log ""
log "Customization:"
log "  - Run 'fcitx5-configtool' to change hotkeys or other settings"
log "  - Restart fcitx5 after making changes: killall fcitx5 && fcitx5 -d"
