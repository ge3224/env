#!/usr/bin/env bash

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/_common.sh"

echo "Setting up development tools..."

echo "Installing language tools and package managers..."
install_packages \
    dart \
    go \
    nodejs \
    npm \
    pnpm \
    opam \
    python-pip \
    python-pipx \
    python-poetry \
    zig \
    zls

echo "Checking for Deno..."
if ! command -v deno >/dev/null 2>&1; then
    echo "Installing Deno..."
    curl -fsSL https://deno.land/install.sh | sh
else
    echo "Deno already installed"
fi

echo "Checking for Rust..."
if ! command -v rustc >/dev/null 2>&1; then
    echo "Installing Rust..."
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    source "$HOME/.cargo/env"
else
    echo "Rust already installed"
fi

echo "Checking opam initialization..."
if [ ! -d "$HOME/.opam" ]; then
    echo "Initializing opam..."
    opam init -y
    eval $(opam env)
else
    echo "opam already initialized"
    eval $(opam env) 2>/dev/null || true
fi

echo "Installing OCaml tools..."
for pkg in odoc ocamlformat utop; do
    if ! opam list --installed "$pkg" >/dev/null 2>&1; then
        echo "Installing $pkg..."
        opam install -y "$pkg"
    else
        echo "$pkg already installed"
    fi
done

echo "Installing Podman..."
install_packages podman podman-compose podman-docker

echo "Enabling Podman socket..."
systemctl --user enable --now podman.socket

echo "Development tools installed!"
echo "Note: Podman runs rootless by default. The podman-docker package provides Docker CLI compatibility."
