#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DOTFILES_DIR="$(dirname "$SCRIPT_DIR")"
source "$SCRIPT_DIR/_common.sh"

echo "Setting up SSH agent with keychain for automatic key loading..."

echo "Installing keychain..."
install_packages keychain
if ! grep -q "keychain.*id_ed25519" "$HOME/.bashrc" 2>/dev/null; then
    echo "Configuring keychain in .bashrc..."
    cat >> "$HOME/.bashrc" << 'EOF'

eval $(keychain --eval --quiet id_ed25519)
EOF
    echo "keychain configured in .bashrc"
else
    echo "keychain already configured in .bashrc"
fi

echo ""
echo "SSH agent setup with keychain completed!"
echo ""
echo "How it works:"
echo "  1. First time you open a terminal: keychain prompts for your SSH key passphrase"
echo "  2. It starts ssh-agent and adds your key"
echo "  3. The agent persists - future terminals/sessions reuse the same agent"
echo "  4. After reboot: first terminal asks for passphrase again, then cached"
echo ""
echo "To test now:"
echo "  1. Open a new terminal (or run: source ~/.bashrc)"
echo "  2. keychain will prompt for your passphrase once"
echo "  3. All future terminals will use the same agent automatically"
