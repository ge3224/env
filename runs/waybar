#!/usr/bin/env bash

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DOTFILES_DIR="$(dirname "$SCRIPT_DIR")"
source "$SCRIPT_DIR/_common.sh"

echo "Setting up waybar configuration..."

echo "Installing waybar..."
install_packages waybar

mkdir -p "$HOME/.config/waybar"

# Clean up any broken symlinks (e.g., old feature branch references)
if [ -L "$HOME/.config/waybar/config" ] && [ ! -e "$HOME/.config/waybar/config" ]; then
    echo "Removing broken symlink: config"
    rm "$HOME/.config/waybar/config"
fi

# Determine which config to use
if [ -n "${PROFILE_WAYBAR_CONFIG:-}" ]; then
    CONFIG_SOURCE="$DOTFILES_DIR/$PROFILE_WAYBAR_CONFIG"
    if [ -f "$CONFIG_SOURCE" ]; then
        echo "Using profile-specific config: $PROFILE_WAYBAR_CONFIG"
    else
        echo "Warning: Profile specified config file not found: $PROFILE_WAYBAR_CONFIG"
        echo "Falling back to default config.jsonc"
        CONFIG_SOURCE="$DOTFILES_DIR/files/waybar/config.jsonc"
    fi
else
    echo "No profile-specific config, using default config.jsonc"
    CONFIG_SOURCE="$DOTFILES_DIR/files/waybar/config.jsonc"
fi

# Symlink the config
if [ -e "$HOME/.config/waybar/config.jsonc" ]; then
    if [ -L "$HOME/.config/waybar/config.jsonc" ]; then
        CURRENT_TARGET=$(readlink "$HOME/.config/waybar/config.jsonc")
        if [ "$CURRENT_TARGET" = "$CONFIG_SOURCE" ]; then
            echo "config.jsonc symlink already points to correct target, skipping"
        else
            echo "Existing waybar config symlink points to different location, updating"
            rm "$HOME/.config/waybar/config.jsonc"
            ln -sf "$CONFIG_SOURCE" "$HOME/.config/waybar/config.jsonc"
        fi
    else
        echo "Backing up existing waybar config to .config/waybar/config.jsonc.backup"
        mv "$HOME/.config/waybar/config.jsonc" "$HOME/.config/waybar/config.jsonc.backup"
        ln -sf "$CONFIG_SOURCE" "$HOME/.config/waybar/config.jsonc"
    fi
else
    ln -sf "$CONFIG_SOURCE" "$HOME/.config/waybar/config.jsonc"
fi

if [ -e "$HOME/.config/waybar/style.css" ]; then
    if [ -L "$HOME/.config/waybar/style.css" ]; then
        CURRENT_TARGET=$(readlink "$HOME/.config/waybar/style.css")
        if [ "$CURRENT_TARGET" = "$DOTFILES_DIR/files/waybar/style.css" ]; then
            echo "style.css symlink already points to correct target, skipping"
        else
            echo "Existing waybar style symlink points to different location, updating"
            rm "$HOME/.config/waybar/style.css"
            ln -sf "$DOTFILES_DIR/files/waybar/style.css" "$HOME/.config/waybar/style.css"
        fi
    else
        echo "Backing up existing waybar style to .config/waybar/style.css.backup"
        mv "$HOME/.config/waybar/style.css" "$HOME/.config/waybar/style.css.backup"
        ln -sf "$DOTFILES_DIR/files/waybar/style.css" "$HOME/.config/waybar/style.css"
    fi
else
    ln -sf "$DOTFILES_DIR/files/waybar/style.css" "$HOME/.config/waybar/style.css"
fi

if [ -e "$HOME/.config/waybar/fcitx5-indicator.sh" ]; then
    if [ -L "$HOME/.config/waybar/fcitx5-indicator.sh" ]; then
        CURRENT_TARGET=$(readlink "$HOME/.config/waybar/fcitx5-indicator.sh")
        if [ "$CURRENT_TARGET" = "$DOTFILES_DIR/files/waybar/fcitx5-indicator.sh" ]; then
            echo "fcitx5-indicator.sh symlink already points to correct target, skipping"
        else
            echo "Existing fcitx5-indicator.sh symlink points to different location, updating"
            rm "$HOME/.config/waybar/fcitx5-indicator.sh"
            ln -sf "$DOTFILES_DIR/files/waybar/fcitx5-indicator.sh" "$HOME/.config/waybar/fcitx5-indicator.sh"
        fi
    else
        ln -sf "$DOTFILES_DIR/files/waybar/fcitx5-indicator.sh" "$HOME/.config/waybar/fcitx5-indicator.sh"
    fi
else
    ln -sf "$DOTFILES_DIR/files/waybar/fcitx5-indicator.sh" "$HOME/.config/waybar/fcitx5-indicator.sh"
fi
chmod +x "$HOME/.config/waybar/fcitx5-indicator.sh"
if [ -n "${PROFILE_WAYBAR_STYLE:-}" ]; then
    STYLE_SOURCE="$DOTFILES_DIR/$PROFILE_WAYBAR_STYLE"
    if [ -f "$STYLE_SOURCE" ]; then
        echo "Symlinking profile-specific style: $PROFILE_WAYBAR_STYLE"
        ln -sf "$STYLE_SOURCE" "$HOME/.config/waybar/local.css"
    else
        echo "Warning: Profile specified style file not found: $PROFILE_WAYBAR_STYLE"
        echo "Creating empty local.css instead"
        touch "$HOME/.config/waybar/local.css"
    fi
else
    echo "No profile-specific style configured, creating empty local.css"
    touch "$HOME/.config/waybar/local.css"
fi

echo "Waybar configuration setup completed!"
echo "Restart waybar with: killall waybar && waybar &"
